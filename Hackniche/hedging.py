import pandas as pd
import numpy as np
from statsmodels.tsa.api import VAR
import streamlit as st
import plotly.graph_objects as go
from datetime import datetime, timedelta
import pandas as pd

# Start date
start_date = datetime.strptime("09-12-2021", "%d-%m-%Y")

# Generate a list of dates
dates = [start_date + timedelta(days=x) for x in range(543)]
print(dates)

# Example dataset
data = pd.DataFrame([
[44539,16.43,285018133],
[44540,16.4,132250784],
[44543,15.5,109326370],
[44544,15.32,87697801],
[44545,14.97,73980448],
[44546,14.64,95179875],
[44547,14.06,93938256],
[44550,13.63,124208458],
[44551,13.93,91725132],
[44552,13.91,79518986],
[44553,13.79,31892288],
[44554,13.65,71664410],
[44557,13.46,53435796],
[44558,13.75,54422460],
[44559,14.45,98802728],
[44560,13.99,178690379],
[44561,15.37,114737274],
[44564,15.55,60819278],
[44565,15.3,28182932],
[44566,15.1,50471883],
[44567,15.3,43568484],
[44568,15.1,44044759],
[44571,14.85,29043222],
[44572,11.8,260773392],
[44573,12.8,133691667],
[44574,12.8,41968967],
[44575,12.75,27998046],
[44578,12.5,31598328],
[44579,12.05,34156792],
[44580,11.95,36982922],
[44581,12.05,22370789],
[44582,11.9,21221417],
[44585,10.95,58784306],
[44586,11.3,44081035],
[44588,10.65,43966888],
[44589,10.8,43595376],
[44592,10.7,32281879],
[44593,10.69,77173955],
[44594,11.4,96007344],
[44595,11.36,45715479],
[44596,11.32,69680415],
[44599,10.97,51664779],
[44600,10.87,50289495],
[44601,10.82,42068161],
[44602,11.16,66847372],
[44603,10.8,44814350],
[44606,10.17,64942799],
[44607,10.69,65290676],
[44608,10.59,58002139],
[44609,10.56,35115934],
[44610,10.66,64424099],
[44613,11.25,154589818],
[44614,10.89,82924542],
[44615,10.72,79486538],
[44616,9.64,145294333],
[44617,10.29,72692780],
[44620,10.32,93013514],
[44622,10.44,57359668],
[44623,11.08,106358631],
[44624,10.33,115731884],
[44627,9.58,88212553],
[44628,9.94,63099118],
[44629,10.29,62731391],
[44630,10.27,69402022],
[44631,10.44,81131552],
[44634,10.22,69794427],
[44635,10.03,101520682],
[44636,10.3,57513545],
[44637,10.27,43213581],
[44641,10.07,57704312],
[44642,10.05,51285389],
[44643,10,64401293],
[44644,10.17,67676307],
[44645,10.11,68475648],
[44648,9.99,55226448],
[44649,9.85,74456686],
[44650,9.83,56201482],
[44651,9.68,112345772],
[44652,10.1,102243569],
[44655,10.29,75784464],
[44656,10.35,92943699],
[44657,10.81,101155463],
[44658,10.91,76557966],
[44659,11.2,97603134],
[44662,10.86,46951025],
[44663,10.6,53538193],
[44664,10.4,43873109],
[44669,10.12,35830477],
[44670,9.9,37213293],
[44671,10.02,26244829],
[44672,10.02,32710464],
[44673,9.93,28410080],
[44676,9.8,42925095],
[44677,10,41150732],
[44678,9.64,39631720],
[44679,9.55,32633949],
[44680,9.51,22479083],
[44683,9.32,16161116],
[44685,9.13,42452508],
[44686,9.08,26075607],
[44687,9.09,29655193],
[44690,8.96,26645418],
[44691,8.74,30122692],
[44692,8.65,40827315],
[44693,8.19,35724492],
[44694,8.33,43219695],
[44697,9.44,80770869],
[44698,9.37,47457218],
[44699,9.22,38437657],
[44700,8.92,38710229],
[44701,9.14,27216110],
[44704,9.04,41430420],
[44705,8.99,26733180],
[44706,8.79,36907147],
[44707,8.6,54079830],
[44708,8.93,39205164],
[44711,9.3,48746442],
[44712,9.62,87299219],
[44713,9.36,40085392],
[44714,9.56,33317819],
[44715,9.23,35463072],
[44718,9.29,26650691],
[44719,9.21,26633091],
[44720,9.17,34368162],
[44721,9.22,20676839],
[44722,9.13,26292158],
[44725,8.71,36971478],
[44726,8.8,25496506],
[44727,8.82,18540147],
[44728,8.51,36171084],
[44729,8.21,51841448],
[44732,7.94,40202926],
[44733,8.47,30537439],
[44734,8.53,39767973],
[44735,8.55,27468785],
[44736,8.73,31183381],
[44739,8.87,30622353],
[44740,8.85,31905338],
[44741,8.65,31233173],
[44742,8.43,36184168],
[44743,8.51,25821941],
[44746,8.38,19784262],
[44747,8.28,25815581],
[44748,8.52,32913545],
[44749,8.47,19993559],
[44750,8.43,19651645],
[44753,8.72,42103188],
[44754,8.69,29789358],
[44755,8.76,19882928],
[44756,8.66,38153009],
[44757,8.71,25404079],
[44760,8.88,30790763],
[44761,8.98,30492483],
[44762,8.84,27786405],
[44763,9.03,32046495],
[44764,8.93,21013382],
[44767,8.92,15320468],
[44768,8.83,17719051],
[44769,8.76,15450705],
[44770,8.68,31889628],
[44771,8.77,21258407],
[44774,9.12,39698003],
[44775,9.41,46667774],
[44776,9.11,34638428],
[44777,8.76,62683906],
[44778,8.78,23998022],
[44781,8.63,21328111],
[44783,8.62,14523819],
[44784,8.67,22661780],
[44785,8.71,22600892],
[44789,8.84,29848468],
[44790,9,26875532],
[44791,8.92,24686822],
[44792,8.79,33138371],
[44795,8.65,23009662],
[44796,8.86,40589344],
[44797,9.21,75361662],
[44798,9.12,73864247],
[44799,9.14,29209013],
[44802,8.89,16693072],
[44803,9.07,50024576],
[44805,9.09,42414980],
[44806,8.97,19463825],
[44809,9.28,57310152],
[44810,9.14,25082137],
[44811,9.77,108096681],
[44812,9.69,60760170],
[44813,9.55,44264272],
[44816,9.63,35756711],
[44817,9.88,59925287],
[44818,9.75,42369811],
[44819,9.64,54559480],
[44820,9.18,48791742],
[44823,9.11,38344364],
[44824,9.16,29702198],
[44825,9.18,36361277],
[44826,9.13,35335341],
[44827,8.97,35570156],
[44830,9,40851595],
[44831,9.14,31956471],
[44832,9.03,35248656],
[44833,8.47,107451211],
[44834,8.79,75380846],
[44837,8.85,51889964],
[44838,9.03,49455098],
[44840,9.02,34452581],
[44841,9.1,45763601],
[44844,8.87,26635194],
[44845,8.65,59437335],
[44846,8.67,24255977],
[44847,8.59,31523187],
[44848,8.51,20734771],
[44851,8.42,49309751],
[44852,8.46,19402336],
[44853,8.52,23231811],
[44854,8.57,28745829],
[44855,8.72,25944292],
[44858,8.69,5253952],
[44859,8.59,59432363],
[44861,8.62,28806555],
[44862,8.54,22205014],
[44865,8.58,17059319],
[44866,8.64,23331546],
[44867,8.56,14131856],
[44868,8.57,22076912],
[44869,8.41,38171830],
[44872,8.33,42913660],
[44874,8.5,37823749],
[44875,8.66,39924234],
[44876,8.49,36817465],
[44879,8.5,55240303],
[44880,8.44,35592715],
[44881,8.41,23949446],
[44882,8.39,19587403],
[44883,8.34,27863390],
[44886,8.42,21423991],
[44887,8.36,24041426],
[44888,8.24,29635117],
[44889,8.06,42721647],
[44890,8.07,36751604],
[44893,8.08,26729156],
[44894,8.07,31402650],
[44895,8.25,38601928],
[44896,8.17,23610352],
[44897,8.29,35033959],
[44900,8.17,28559746],
[44901,8.07,44567052],
[44902,8,28389493],
[44903,8.03,22427720],
[44904,7.97,86853151],
[44907,7.93,49898961],
[44908,7.91,38928402],
[44909,8.67,217811745],
[44910,8.4,107323191],
[44911,8.32,44405808],
[44914,8.37,98033153],
[44915,8.25,44078816],
[44916,8.01,66637987],
[44917,8.01,122345530],
[44918,7.68,57530764],
[44921,7.84,44179494],
[44922,7.91,29056148],
[44923,7.96,60198869],
[44924,7.89,46556573],
[44925,7.9,117924606],
[44928,8,79912393],
[44929,7.96,142659928],
[44930,7.81,94678336],
[44931,7.87,319195454],
[44932,7.79,93915147],
[44935,7.45,199529324],
[44936,7.25,61522782],
[44937,7.46,116997698],
[44938,7.33,99021484],
[44939,7.31,327842534],
[44942,7.22,222550016],
[44943,7.29,749964922],
[44944,7.32,115347034],
[44945,7.42,801207011],
[44946,7.26,31594336],
[44949,7.09,39751750],
[44950,7.08,43511726],
[44951,6.77,36086356],
[44953,6.41,37387655],
[44956,6.79,39300506],
[44957,7.07,22286393],
[44958,6.7,31343712],
[44959,6.82,18996062],
[44960,6.89,30314090],
[44963,8.26,201931490],
[44964,7.94,54866042],
[44965,7.92,32214357],
[44966,7.87,24215018],
[44967,7.88,23686456],
[44970,7.86,24491360],
[44971,7.69,19849633],
[44972,7.75,13497500],
[44973,7.49,29777582],
[44974,7.23,39454082],
[44977,7.08,37868637],
[44978,7.02,20401658],
[44979,7.02,32006858],
[44980,6.68,39536539],
[44981,6.75,34932871],
[44984,6.68,31624943],
[44985,6.83,17672166],
[44986,6.9,29680040],
[44987,6.95,19334873],
[44988,6.9,22823276],
[44991,6.95,23445110],
[44993,6.93,21803237],
[44994,6.87,18049724],
[44995,6.77,21007845],
[44998,6.59,27978909],
[44999,6.57,24628303],
[45000,6.41,29199131],
[45001,6.44,32387607],
[45002,6.39,25535667],
[45005,6.33,20894911],
[45006,6.32,18210397],
[45007,6.54,38380066],
[45008,6.43,26092524],
[45009,6.27,36103055],
[45012,6.04,40522870],
[45013,5.91,39460562],
[45014,5.88,51190497],
[45016,5.82,42284807],
[45019,6.15,34781544],
[45021,6.24,28481360],
[45022,6.26,20867315],
[45026,6.15,13574085],
[45027,6.11,16015212],
[45028,6.18,20469193],
[45029,6.09,17388000],
[45033,6.08,12881241],
[45034,6.06,15153425],
[45035,6.08,24225543],
[45036,6.06,15213256],
[45037,6.48,73877211],
[45040,6.37,30396910],
[45041,6.33,19879400],
[45042,6.54,50525665],
[45043,6.89,73671335],
[45044,6.95,21414129],
[45048,6.88,35408666],
[45049,6.93,16546019],
[45050,7.01,32321047],
[45051,6.92,17224091],
[45054,6.92,10828480],
[45055,6.83,15943411],
[45056,6.76,27084399],
[45057,7.12,70912967],
[45058,7.02,18616239],
[45061,7.09,22741092],
[45062,7.35,48063208],
[45063,7.07,27835857],
[45064,7.02,18860258],
[45065,7.03,18143616],
[45068,7.02,14877823],
[45069,6.98,14672829],
[45070,6.96,20090827],
[45071,6.99,33113520],
[45072,7.07,19890116],
[45075,7.13,41692317],
[45076,7.11,22766736],
[45077,7.17,19552569],
[45078,7.17,10013943],
[45079,7.16,9322616],
[45082,7.13,15414257],
[45083,7.08,9459676],
[45084,7.68,68170325],
[45085,7.37,36638240],
[45086,7.31,29388413],
[45089,7.5,20515284],
[45090,7.71,38608184],
[45091,7.92,83486433],
[45092,7.82,29617164],
[45093,7.79,23799744],
[45096,7.64,21391436],
[45097,7.41,28458326],
[45098,7.75,45762999],
[45099,7.46,38507055],
[45100,7.47,26783955],
[45103,7.62,33603688],
[45104,7.53,32233838],
[45105,7.46,36272156],
[45107,7.43,23321466],
[45110,7.53,23358385],
[45111,7.46,20086408],
[45112,7.42,19657187],
[45113,7.48,18017280],
[45114,7.45,14441770],
[45117,7.39,17547229],
[45118,7.38,11827613],
[45119,7.36,16392801],
[45120,7.25,23349718],
[45121,7.32,15445692],
[45124,7.63,39982469],
[45125,7.63,54040166],
[45126,7.69,45116158],
[45127,7.57,29957459],
[45128,7.86,64936579],
[45131,7.92,71746871],
[45132,7.92,56392413],
[45133,8.72,143839193],
[45134,8.47,63401976],
[45135,8.33,28275792],
[45138,8.34,33254015],
[45139,8.27,25670918],
[45140,7.92,46265578],
[45141,7.87,27747240],
[45142,8.25,58296714],
[45145,8.37,47602161],
[45146,8.28,64680123],
[45147,8.2,26308951],
[45148,8.07,38534308],
[45149,8.11,21876269],
[45152,8.04,24136431],
[45154,7.82,26968088],
[45155,7.74,35991857],
[45156,7.62,19448499],
[45159,7.56,22923354],
[45160,7.71,58247028],
[45161,7.82,19446340],
[45162,7.95,23660185],
[45163,8.69,139594686],
[45166,8.99,100698238],
[45167,8.92,86413973],
[45168,9.08,72784414],
[45169,9.05,52544872],
[45170,10.03,183926798],
[45173,9.99,80701920],
[45174,9.9,39324747],
[45175,10.65,131397481],
[45176,10.48,79453041],
[45177,10.48,82088500],
[45180,11.27,121197366],
[45181,10.52,97839777],
[45182,10.98,56098478],
[45183,10.9,21138750],
[45184,11.73,178222771],
[45187,10.93,102145156],
[45189,11,37496800],
[45190,10.86,39209930],
[45191,11.31,74746564],
[45194,11.32,41726890],
[45195,12.11,127612364],
[45196,12.01,68689146],
[45197,11.65,56086229],
[45198,11.67,39404699],
[45202,11.99,64675829],
[45203,11.49,38017706],
[45204,11.22,45748071],
[45205,10.94,26513792],
[45208,10.9,51292215],
[45209,11.07,29487346],
[45210,11.88,111662750],
[45211,11.89,57882497],
[45212,12.01,44115113],
[45215,11.82,41381263],
[45216,11.94,45137074],
[45217,11.69,38515952],
[45218,11.99,49868876],
[45219,11.76,30615828],
[45222,10.95,43834963],
[45224,10.86,48043117],
[45225,10.73,44075284],
[45226,10.88,42869372],
[45229,11.65,70769570],
[45230,11.89,79625822],
[45231,12.78,263960432],
[45232,13.75,140874620],
[45233,13.74,138107037],
[45236,13.54,33205581],
[45237,13.87,38202549],
[45238,13.64,33412283],
[45239,13.91,40258480],
[45240,13.73,53981594],
[45243,13.95,26932448],
[45245,14.07,36640053],
[45246,14.4,66537940],
[45247,14.55,56240162],
[45250,14.16,71255078],
[45251,13.85,54727898],
[45252,13.49,45063375],
[45253,13.6,27416158],
[45254,13.35,25033494],
[45258,13.28,35688694],
[45259,13.24,29868737],
[45260,13.06,72663317],
[45261,13.27,31168083],
[45264,13.15,76147134],
[45265,13.06,50323620],
[45266,12.84,32723551],
[45267,13.22,47071666],
[45268,12.88,49028096],
[45271,13.14,36795184],
[45272,13.13,33383125],
[45273,13.18,53776699],
[45274,13.94,72630603],
[45275,14.04,52993207],
[45278,14.09,61954336],
[45279,14.01,43323366],
[45280,13.09,80415079],
[45281,13.66,48834423],
[45282,13.61,47382840],
[45286,13.37,56581235],
[45287,13.43,36657426],
[45288,13.24,46921833],
[45289,16.02,298985635],
[45292,16.99,219276844],
[45293,16.03,126742245],
[45294,15.89,66534725],
[45295,16.81,89264929],
[45296,17.11,109689419],
[45299,17.15,54305779],
[45300,16.22,68193185],
[45301,16.13,34839723],
[45302,16.06,17957631],
[45303,15.87,26823595],
[45306,16.47,50461549],
[45307,15.74,64239631],
[45308,15.09,58668104],
[45309,15.11,41528830],
[45310,15.08,46647079],
[45314,14.39,50652278],
[45315,14.94,50400245],
[45316,14.61,59872461],
[45320,14.7,37034056],
[45321,14.49,48009206],
[45322,14.36,31239566],
[45323,14.15,37252528],
[45324,14.04,46155944],
[45327,13.72,31413786],
[45328,14.24,61094061],
[45329,14.98,87598206],
[45330,14.82,55991914],
[45331,15.52,89584746],
[45334,14.47,62056544],
[45335,14.71,43683341],
[45336,15.56,96071529],
[45337,15.95,82058908],
[45338,15.91,67701404]], columns=["Drop", "Price", "Volume"])

data["date"] = dates

data.drop("Drop", axis=1, inplace=True)

data.set_index('date', inplace=True)

# Preprocess data (e.g., fill missing values)
def preprocess_data(data):
    return data.fillna(method='ffill')

# Fit VAR model
def fit_var_model(data, lags):
    model = VAR(data)
    model_fitted = model.fit(lags)
    return model_fitted

# Preprocess the data
data = preprocess_data(data)

# Streamlit UI
st.title('Hedging Stratergies')

# Assuming you want to manually specify these instead of using Streamlit widgets
lags = 5  # Example: Number of lags
steps = 200  # Example: Forecast steps

# Fit the model
model_fitted = fit_var_model(data, lags)



# Forecasting
forecast, stderr, conf_int = model_fitted.forecast_interval(data.values[-lags:], steps=steps)
forecast_df = pd.DataFrame(forecast, index=pd.date_range(start=data.index[-1] + pd.Timedelta(days=1), periods=steps, freq='D'), columns=data.columns)

# Plotting forecast
# Plotting past and forecasted values
fig = go.Figure()
# Plot historical data
for col in data.columns.drop("Volume"):
    fig.add_trace(go.Scatter(x=data.index, y=data[col], mode='lines', name=f'{col} - Historical'))

# Plot forecasted data
for col in forecast_df.columns.drop("Volume"):
    fig.add_trace(go.Scatter(x=forecast_df.index, y=forecast_df[col], mode='lines+markers', name=f'{col} - Forecast'))

# Add a vertical line for the current date
current_date = data.index[-1]
fig.add_vline(x=current_date, line_width=2, line_dash="dash", line_color="grey")

# Update layout
fig.update_layout(title="VAR Forecast with Historical Data",
                  xaxis_title="Date",
                  yaxis_title="Value",
                  legend_title="Variable")

# Show plot in Streamlit
st.plotly_chart(fig)

# Calculate the average of the forecasted values for each variable
forecast_avg = forecast_df.mean()

# Access the last value of each variable in the dataframe
last_values = data.iloc[-1]

# Recommendations based on the comparison
hedging_recommendations = ""
# Recommendations based on the comparison
hedging_recommendations = ""


if forecast_avg[col] < last_values[col]:
        # If the average forecast is less than the last historical value
        hedging_recommendations += f"""For {col}, Objective: Protect against potential declines in asset value.
Approach: Purchase put options to secure the right to sell the underlying asset at a predetermined strike price before the option expires. This strategy ensures that if the asset's market price falls below this strike price, you can still sell it at the higher, agreed-upon price, thereby limiting your losses.
Key Considerations:
Strike Price Selection: Choose a strike price that provides an acceptable level of protection versus the cost (premium) of the option.
Expiration Date: The expiration date should align with your forecast period or the timeframe over which you seek protection.
Premium Cost: Evaluate the cost of the option against the potential benefit of protection to ensure it's economically viable.\n"""
else:
        # Other hedging strategies
        hedging_recommendations += f"""For {col}, 
Objective: Mitigate risk and protect against volatility in a stable or upward-trending market.
Approach:
Diversification: Spread investments across various assets, sectors, or instruments to reduce the impact of any single market movement.
Futures Contracts: Use futures contracts to lock in future sale or purchase prices for assets. This can protect against unfavorable price movements by setting known prices for transactions ahead of time.
Key Considerations:
Portfolio Balance: Ensure diversification addresses all major sources of risk without diluting potential returns excessively.
Futures Strategy: Select contracts that align with your market outlook and hedging needs, considering the contract size, expiration, and underlying asset.\n"""

# Display the recommendations in Streamlit
st.write(hedging_recommendations)



